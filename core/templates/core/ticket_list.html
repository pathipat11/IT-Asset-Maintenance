{% extends "core/base.html" %}
{% block title %}Tickets{% endblock %}
{% block content %}

<div class="page-header mb-3">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
            <h3 class="m-0 fw-bold">Tickets</h3>
            <div class="text-muted small mt-1">
                Search, filter, and track SLA / overdue tickets quickly.
            </div>
        </div>
        <a class="btn btn-primary" href="{% url 'core:ticket_create' %}">+ New Ticket</a>
    </div>
</div>

<!-- Quick pills -->
<div class="pillbar mb-3">
    {% with mine=request.GET.mine overdue=request.GET.overdue %}
    <a class="pill {% if mine == '1' %}active{% endif %}" href="{% url 'core:ticket_list' %}?mine=1">My Queue</a>
    <a class="pill {% if overdue == '1' %}active{% endif %}" href="{% url 'core:ticket_list' %}?overdue=1">Overdue</a>
    <a class="pill {% if not mine and not overdue and not request.GET.q and not request.GET.status %}active{% endif %}"
        href="{% url 'core:ticket_list' %}">
        Reset
    </a>
    {% endwith %}
</div>

<!-- Filters -->
<div class="filter-card p-3 mb-3">
    <form class="row g-2 align-items-end">
        <div class="col-md-6">
            <label class="form-label small text-muted mb-1">Search</label>
            <input class="form-control" name="q" placeholder="Ticket no / subject / asset code"
                value="{{ request.GET.q }}">
        </div>

        <div class="col-md-3">
            <label class="form-label small text-muted mb-1">Status</label>
            <select class="form-select" name="status">
                <option value="">All Status</option>
                {% for k,v in view.model.Status.choices %}
                <option value="{{ k }}" {% if request.GET.status == k %}selected{% endif %}>{{ v }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3 d-grid">
            <button class="btn btn-outline-primary">Apply Filters</button>
        </div>

        <!-- Preserve quick filters if present -->
        {% if request.GET.mine %}
        <input type="hidden" name="mine" value="{{ request.GET.mine }}">
        {% endif %}
        {% if request.GET.overdue %}
        <input type="hidden" name="overdue" value="{{ request.GET.overdue }}">
        {% endif %}
    </form>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Ticket List</span>
        <span class="badge badge-soft">{{ tickets|length }} on this page</span>
    </div>

    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle table-clean mb-0">
                <thead>
                    <tr>
                        <th style="width: 170px;">No</th>
                        <th style="width: 140px;">Asset</th>
                        <th>Subject</th>
                        <th style="width: 170px;">Status</th>
                        <th style="width: 160px;">Priority</th>
                        <th style="width: 200px;">Due</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in tickets %}
                    <tr>
                        <td>
                            <a class="fw-semibold" href="{% url 'core:ticket_detail' t.id %}">{{ t.ticket_no }}</a>
                        </td>
                        <td class="text-muted">{{ t.asset.asset_code }}</td>
                        <td>{{ t.subject }}</td>

                        <td>
                            {% if t.due_at %}
                            {% if t.due_at < now and t.status != "DONE" and t.status != "CLOSED" %} <span
                                class="badge-status overdue">OVERDUE</span>
                                {% else %}
                                {% if t.status == "NEW" %}
                                <span class="badge-status new">{{ t.get_status_display }}</span>
                                {% elif t.status == "ASSIGNED" %}
                                <span class="badge-status assigned">{{ t.get_status_display }}</span>
                                {% elif t.status == "IN_PROGRESS" %}
                                <span class="badge-status progress">{{ t.get_status_display }}</span>
                                {% elif t.status == "DONE" %}
                                <span class="badge-status done">{{ t.get_status_display }}</span>
                                {% elif t.status == "CLOSED" %}
                                <span class="badge-status closed">{{ t.get_status_display }}</span>
                                {% else %}
                                <span class="badge-status">{{ t.get_status_display }}</span>
                                {% endif %}
                                {% endif %}
                                {% else %}
                                <!-- no due_at -->
                                {% if t.status == "NEW" %}
                                <span class="badge-status new">{{ t.get_status_display }}</span>
                                {% elif t.status == "ASSIGNED" %}
                                <span class="badge-status assigned">{{ t.get_status_display }}</span>
                                {% elif t.status == "IN_PROGRESS" %}
                                <span class="badge-status progress">{{ t.get_status_display }}</span>
                                {% elif t.status == "DONE" %}
                                <span class="badge-status done">{{ t.get_status_display }}</span>
                                {% elif t.status == "CLOSED" %}
                                <span class="badge-status closed">{{ t.get_status_display }}</span>
                                {% else %}
                                <span class="badge-status">{{ t.get_status_display }}</span>
                                {% endif %}
                                {% endif %}
                        </td>

                        <td>
                            {% if t.priority == "LOW" %}
                            <span class="badge-priority low">{{ t.get_priority_display }}</span>
                            {% elif t.priority == "MEDIUM" %}
                            <span class="badge-priority medium">{{ t.get_priority_display }}</span>
                            {% elif t.priority == "HIGH" %}
                            <span class="badge-priority high">{{ t.get_priority_display }}</span>
                            {% elif t.priority == "URGENT" %}
                            <span class="badge-priority urgent">{{ t.get_priority_display }}</span>
                            {% else %}
                            <span class="badge-priority">{{ t.get_priority_display }}</span>
                            {% endif %}
                        </td>

                        <td class="text-muted">
                            {% if t.due_at %}
                            {{ t.due_at|date:"Y-m-d H:i" }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>

                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mt-3">
            {% include "core/partials/pagination.html" %}
        </div>
    </div>
</div>

{% endblock %}